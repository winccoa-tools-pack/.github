name: Cleanup Prereleases by Branch (Reusable)

on:
  workflow_call:
    inputs:
      target_branch:
        description: "Branch identifier to match in release body (matches 'Source branch: <target_branch>')"
        required: true
        type: string
      keep_latest:
        description: "How many matching prereleases to keep"
        required: false
        default: 1
        type: number
      list_limit:
        description: "How many releases to scan"
        required: false
        default: 200
        type: number
    secrets:
      token:
        description: "Optional PAT (otherwise uses GITHUB_TOKEN)"
        required: false

permissions:
  contents: write

jobs:
  cleanup:
    runs-on: ubuntu-latest

    steps:
      - name: Remove older prereleases for this branch
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.token != '' && secrets.token || secrets.GITHUB_TOKEN }}
          TARGET_BRANCH: ${{ inputs.target_branch }}
          KEEP_LATEST: ${{ inputs.keep_latest }}
          LIST_LIMIT: ${{ inputs.list_limit }}
        run: |
          set -euo pipefail

          REPO="${GITHUB_REPOSITORY}"

          if [ -z "${TARGET_BRANCH}" ]; then
            echo "::error::inputs.target_branch is required"
            exit 1
          fi

          if ! [[ "${KEEP_LATEST}" =~ ^[0-9]+$ ]]; then
            echo "::error::inputs.keep_latest must be a non-negative integer (got: ${KEEP_LATEST})"
            exit 1
          fi

          echo "ðŸ§¹ Cleaning prereleases for branch: ${TARGET_BRANCH} (keep latest ${KEEP_LATEST})"

          TAGS_OUTPUT=$(gh release list --repo "$REPO" --limit "${LIST_LIMIT}" --json tagName,isPrerelease,createdAt \
            --jq '[.[] | select(.isPrerelease == true)] | sort_by(.createdAt) | reverse | .[].tagName')

          mapfile -t ALL_TAGS <<< "$TAGS_OUTPUT"

          if [ ${#ALL_TAGS[@]} -eq 0 ]; then
            echo "âœ… No prereleases found"
            exit 0
          fi

          MATCHED=()
          for TAG in "${ALL_TAGS[@]}"; do
            BODY=$(gh release view --repo "$REPO" "$TAG" --json body --jq '.body' 2>/dev/null || true)
            if echo "$BODY" | grep -q "Source branch: ${TARGET_BRANCH}"; then
              MATCHED+=("$TAG")
            fi
          done

          if [ ${#MATCHED[@]} -le ${KEEP_LATEST} ]; then
            echo "âœ… Nothing to delete (matched ${#MATCHED[@]} prereleases)"
            exit 0
          fi

          echo "Found ${#MATCHED[@]} prereleases for '${TARGET_BRANCH}':"
          printf '  - %s\n' "${MATCHED[@]}"

          TO_DELETE=("${MATCHED[@]:${KEEP_LATEST}}")
          echo "Deleting ${#TO_DELETE[@]} older prereleases:"
          printf '  - %s\n' "${TO_DELETE[@]}"

          for TAG in "${TO_DELETE[@]}"; do
            gh release delete --repo "$REPO" "$TAG" --yes --cleanup-tag || echo "::warning::Failed to delete $TAG"
          done
