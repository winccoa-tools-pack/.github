name: Reusable - Sync from template repo and open PR
on:
  workflow_call:
    inputs:
      template_repo:
        description: "Source template repository (owner/repo)"
        required: true
        type: string
      template_ref:
        description: "Branch or tag in the template repo"
        required: false
        default: "main"
        type: string
      sync_mode:
        description: "update (copy/overwrite) or mirror (exact match with deletions)"
        required: false
        default: "update"
        type: string
      paths:
        description: |
          Newline-separated globs (relative to template repo) to sync.
          Example:
            .github/ISSUE_TEMPLATE/**/*.yml
            .github/ISSUE_TEMPLATE/**/*.yaml
        required: true
        type: string
      pr_title:
        description: "Pull Request title"
        required: false
        default: "chore(template): sync from template repository"
        type: string
      pr_body:
        description: "Pull Request body"
        required: false
        default: "Automated sync from template."
        type: string
      pr_labels:
        description: "Comma-separated labels"
        required: false
        default: "sync, automated"
        type: string
      pr_reviewers:
        description: "Comma-separated reviewers (users or org/teams)"
        required: false
        default: ""
        type: string
      branch_prefix:
        description: "Prefix for the sync branch"
        required: false
        default: "chore/template-sync"
        type: string
    secrets:
      token:
        description: "Optional PAT if you prefer over GITHUB_TOKEN"
        required: false

jobs:
  sync:
    permissions:
      contents: write        # push branch
      pull-requests: write   # open/update PR
    runs-on: ubuntu-latest

    env:
      TEMPLATE_REPO: ${{ inputs.template_repo }}
      TEMPLATE_REF:  ${{ inputs.template_ref }}
      SYNC_MODE:     ${{ inputs.sync_mode }}
      PATHS:         ${{ inputs.paths }}
      BRANCH_PREFIX: ${{ inputs.branch_prefix }}

    steps:
      # 1) Checkout child repo into ./target
      - name: Checkout child repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          path: target

      # 2) Checkout template repo into ./template
      - name: Checkout template repo
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.template_repo }}
          ref:        ${{ inputs.template_ref }}
          path:       template

      # 3) Copy only the files you manage (example for issue templates)
      - name: Sync files from template to child
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob dotglob
          : > globs.txt
          printf "%s\n" "${PATHS}" >> globs.txt

          mkdir -p sync_stage
          while IFS= read -r GLOB || [[ -n "$GLOB" ]]; do
            [[ -z "$GLOB" || "$GLOB" =~ ^[[:space:]]*# ]] && continue
            for f in template/$GLOB; do
              rel="${f#template/}"
              dest_dir="sync_stage/$(dirname "$rel")"
              mkdir -p "$dest_dir"
              cp -f "$f" "$dest_dir/"
            done
          done < globs.txt

      - name: Apply sync (update or mirror)
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${SYNC_MODE}" == "mirror" ]]; then
            # Mirror the selected subtrees exactly (delete extras)
            # Derive unique top-level subtrees from the globs
            awk '!/^#|^$/{print $0}' globs.txt \
              | sed -E 's#/[^/]+$##' | sed -E 's#/\*\*.*$##' \
              | sort -u | while read -r top; do
                  [[ -z "$top" ]] && continue
                  mkdir -p "$top"
                  rsync -a --delete "sync_stage/$top/" "$top/"
                done
          else
            # Update only: copy files over, keep extras
            rsync -a sync_stage/ ./
          fi

      - name: Open or update PR
        uses: peter-evans/create-pull-request@v8
        with:
          path:   target                                # <â€” critical
          branch: ${{ inputs.branch_prefix }}-${{ github.run_id }}-${{ github.run_attempt }}
          base:   ${{ github.event.repository.default_branch }} # e.g. main or develop
          title:  ${{ inputs.pr_title }}
          body:   ${{ inputs.pr_body }}
          labels: ${{ inputs.pr_labels }}
          reviewers: ${{ inputs.pr_reviewers }}
          draft:  false


