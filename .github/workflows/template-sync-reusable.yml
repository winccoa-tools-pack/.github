
name: Reusable - Sync from template repo and open PR

on:
  workflow_call:
    inputs:
      template_repo:
        description: "Source template repository (owner/repo)"
        required: true
        type: string
      template_ref:
        description: "Branch or tag in the template repo"
        required: false
        default: "main"
        type: string
      sync_mode:
        description: "update (copy/overwrite) or mirror (exact match with deletions)"
        required: false
        default: "update"
        type: string
      paths:
        description: |
          Newline-separated globs (relative to template repo) to sync.
          Example:
            .github/ISSUE_TEMPLATE/**/*.yml
            .github/ISSUE_TEMPLATE/**/*.yaml
        required: true
        type: string
      pr_title:
        description: "Pull Request title"
        required: false
        default: "chore(template): sync from template repository"
        type: string
      pr_body:
        description: "Pull Request body"
        required: false
        default: "Automated sync from template."
        type: string
      pr_labels:
        description: "Comma-separated labels"
        required: false
        default: "sync, automated"
        type: string
      pr_reviewers:
        description: "Comma-separated reviewers (users or org/teams)"
        required: false
        default: ""
        type: string
      branch_prefix:
        description: "Prefix for the sync branch"
        required: false
        default: "chore/template-sync"
        type: string
    secrets:
      token:
        description: "Optional PAT if you prefer over GITHUB_TOKEN"
        required: false

jobs:
  sync:
    permissions:
      contents: write
      pull-requests: write
    runs-on: ubuntu-latest

    env:
      TEMPLATE_REPO: ${{ inputs.template_repo }}
      TEMPLATE_REF:  ${{ inputs.template_ref }}
      SYNC_MODE:     ${{ inputs.sync_mode }}
      PATHS:         ${{ inputs.paths }}
      BRANCH_PREFIX: ${{ inputs.branch_prefix }}

    steps:
      - name: Checkout caller repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout template repo
        uses: actions/checkout@v4
        with:
          repository: ${{ env.TEMPLATE_REPO }}
          ref:        ${{ env.TEMPLATE_REF }}
          path:       template

      - name: Prepare sync set
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob dotglob globstar

          : > globs.txt
          printf "%s\n" "${PATHS}" >> globs.txt
          # normalize CRLF just in case
          tr -d '\r' < globs.txt > globs.clean && mv globs.clean globs.txt

          mkdir -p sync_stage
          while IFS= read -r GLOB || [[ -n "$GLOB" ]]; do
            [[ -z "$GLOB" || "$GLOB" =~ ^[[:space:]]*# ]] && continue
            for f in template/$GLOB; do
              rel="${f#template/}"
              dest_dir="sync_stage/$(dirname "$rel")"
              mkdir -p "$dest_dir"
              cp -f "$f" "$dest_dir/"
            done
          done < globs.txt

          if ! compgen -G "sync_stage/**" > /dev/null; then
            echo "::warning::No files matched the provided globs from template repo"
          fi

      - name: Apply sync (update or mirror)
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${SYNC_MODE}" == "mirror" ]]; then
            rsync -a --delete "sync_stage/" "./"
          else
            rsync -a "sync_stage/" "./"
          fi

      - name: Open or update PR
        uses: peter-evans/create-pull-request@v8
        with:
          token:   ${{ secrets.token || github.token }}
          commit-message: ${{ inputs.pr_title }}
          branch: ${{ inputs.branch_prefix }}-${{ github.run_id }}-${{ github.run_attempt }}
          base:   ${{ github.event.repository.default_branch }}
          title:  ${{ inputs.pr_title }}
          body:   ${{ inputs.pr_body }}
          labels: ${{ inputs.pr_labels }}
          reviewers: ${{ inputs.pr_reviewers }}
          draft:  false
