
name: Fan-out labels to repositories

on:
  workflow_dispatch:
    inputs:
      strict:
        description: "Delete labels not defined"
        required: false
        default: false
        type: boolean
      dry-run:
        description: "Preview only"
        required: false
        default: false
        type: boolean
      ref:
        description: "Branch/tag in .github to read labels from"
        required: false
        default: main
        type: string

  push:
    branches: [ develop, main ]
    paths: [ "labels/labels.yml", "repos.txt" ]

permissions:
  contents: read

jobs:
  plan:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      labels-ref: ${{ steps.set-ref.outputs.ref }}
    steps:
      - uses: actions/checkout@v4

      - id: set-ref
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ inputs.ref }}" ]; then
            echo "ref=${{ inputs.ref }}" >> $GITHUB_OUTPUT
          else
            echo "ref=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi

      - id: set-matrix
        run: |
          repos=$(grep -v '^\s*$' repos.txt | grep -v '^#' | jq -R . | jq -s .)
          echo "matrix={\"repo\": $repos}" >> $GITHUB_OUTPUT

  apply:
    needs: plan
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.plan.outputs.matrix) }}
    steps:
      - name: Checkout org .github (labels source)
        uses: actions/checkout@v4
        with:
          repository: winccoa-tools-pack/.github
          ref: ${{ needs.plan.outputs.labels-ref }}
          path: org-dot-github

      - name: Dry run plan for ${{ matrix.repo }}
        if: ${{ inputs.dry-run }}
        run: |
          echo "Dry run enabled. Would apply labels from labels/labels.yml to: ${{ matrix.repo }}"
          cat org-dot-github/labels/labels.yml

      - name: Apply labels via GitHub API (Python)
        if: ${{ !inputs.dry-run }}
        env:
          GITHUB_TOKEN: ${{ secrets.ORG_LABELS_PAT }}
          TARGET_REPO: ${{ matrix.repo }}
          STRICT: ${{ inputs.strict }}
        run: |
          python3 - << 'PY'
          import os, sys, json
          import requests
          try:
              import yaml
          except Exception:
              import subprocess
              subprocess.check_call([sys.executable, "-m", "pip", "install", "pyyaml"])
              import yaml

          GITHUB_TOKEN = os.environ["GITHUB_TOKEN"]
          TARGET_REPO = os.environ["TARGET_REPO"]
          STRICT = os.environ.get("STRICT","false").lower() == "true"

          headers = {
              "Authorization": f"Bearer {GITHUB_TOKEN}",
              "Accept": "application/vnd.github+json"
          }

          with open("org-dot-github/labels/labels.yml", "r", encoding="utf-8") as f:
              desired = yaml.safe_load(f) or []

          labels_url = f"https://api.github.com/repos/{TARGET_REPO}/labels"

          # Current labels
          current = []
          page = 1
          while True:
              r = requests.get(labels_url, headers=headers, params={"per_page":100, "page":page})
              r.raise_for_status()
              batch = r.json()
              if not batch: break
              current.extend(batch)
              page += 1

          current_by_name = {l["name"]: l for l in current}
          desired_by_name = {l["name"]: l for l in desired}

          # Upsert
          for item in desired:
              name = item["name"]
              color = item.get("color","ffffff")
              desc = item.get("description","") or ""
              if name in current_by_name:
                  url = f"https://api.github.com/repos/{TARGET_REPO}/labels/{requests.utils.quote(name, safe='')}"
                  payload = {"name": name, "color": color, "description": desc}
                  resp = requests.patch(url, headers=headers, json=payload)
                  resp.raise_for_status()
                  print(f"Updated: {name}")
              else:
                  payload = {"name": name, "color": color, "description": desc}
                  resp = requests.post(labels_url, headers=headers, json=payload)
                  resp.raise_for_status()
                  print(f"Created: {name}")

          # Delete (strict)
          if STRICT:
              for name in list(current_by_name.keys()):
                  if name not in desired_by_name:
                      url = f"https://api.github.com/repos/{TARGET_REPO}/labels/{requests.utils.quote(name, safe='')}"
                      resp = requests.delete(url, headers=headers)
                      resp.raise_for_status()
                      print(f"Deleted (strict): {name}")

          print("Done.")
          PY
